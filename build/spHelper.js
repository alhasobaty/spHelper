'use strict';var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();Object.defineProperty(exports,'__esModule',{value:!0});function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var spHelper=function(){function a(b){_classCallCheck(this,a),this.crossDomain=!1,this.targetSite='',this.appContext={},this.spWeb={},this.initializeOptions(b)}return _createClass(a,[{key:'initializeOptions',value:function b(a){if('undefined'!=typeof a.targetSite&&(this.targetSite=a.targetSite),'undefined'!=typeof a.crossDomain&&!0===a.crossDomain)if(''!==this.targetSite)this.setCrossDomain();else throw'spHelper Error: Configuration error. Cannot set cross domain communication without a target site.';this.setClientContext(),this.setWeb()}},{key:'setCrossDomain',value:function a(){this.crossDomain=!0}},{key:'setClientContext',value:function a(){''!==this.targetSite&&!1===this.crossDomain?this.appContext=new SP.ClientContext(this.targetSite):(this.appContext=new SP.ClientContext.get_current,!0===this.crossDomain&&(this.crossContext=new SP.AppContextSite(this.appContext,this.targetSite)))}},{key:'setWeb',value:function a(){this.spWeb=!0===this.crossDomain?this.crossContext.get_web():this.appContext.get_web()}},{key:'getSiteProperty',value:function g(a,b,c){if('undefined'==typeof a)throw'spHelper Error: Unable to get the site property. Ensure the siteProperty [ARRAY] is correctly configured.';try{this.appContext.load(this.spWeb,a);var d=this,e=function(){var c={};a.includes('Title')&&(c.Title=d.spWeb.get_title()),a.includes('Url')&&(c.Url=d.spWeb.get_url()),a.includes('ServerRelativeUrl')&&(c.ServerRelativeUrl=d.spWeb.get_serverRelativeUrl()),a.includes('MasterUrl')&&(c.MasterUrl=d.spWeb.get_masterUrl()),b(c)},f=function(a,b){c(b.get_message())};this.appContext.executeQueryAsync(e,f)}catch(a){throw'spHelper Error: Unable to get the site property. Validate the request details.'+a}}},{key:'getListData',value:function h(a,b,c){'undefined'==typeof a.pagePosition&&(a.pagePosition=0);var d=[],e=this,f=function(c){d=d.concat(c),5e3==c.length?(5e3==d.length&&++a.pagePosition,a.pagePosition+=5e3,e.loadListData(a,f,g)):b(d)},g=function(a){c(a)};this.loadListData(a,f,g)}},{key:'loadListData',value:function l(a,b,c){if('undefined'==typeof a.listName&&'undefined'==typeof a.listGuid||'undefined'==typeof a.listColumns||'undefined'==typeof a.pagePosition)throw'spHelper Error: Invalid query details. Minimum query details must include list title, columns and page position.';try{var m='';m='undefined'==typeof a.listName?this.spWeb.get_lists().getById(a.listGuid):this.spWeb.get_lists().getByTitle(a.listName);var n=new SP.CamlQuery;if('undefined'!=typeof a.query)n.set_viewXml(a.query);else{var o='<View Scope=\'RecursiveAll\'>';for(var p in o+='<ViewFields>',a.listColumns)o+='<FieldRef Name=\''+a.listColumns[p]+'\' />';if(o+='</ViewFields>','undefined'!=typeof a.where){var d=!1,e=!1,f=0;if('undefined'==typeof a.where.value&&(a.where.value=''),o+='<Query> <Where>','undefined'!=typeof a.where.values)o+='<'+a.where.operation+'>',a.where.values.forEach(function(a){o+='<'+a.operation+'>',o+='lookup'!==a.type.toLowerCase()||isNaN(a.value)?'<FieldRef Name=\''+a.column+'\'/> <Value Type=\''+a.type+'\'>'+a.value+'</Value>':'<FieldRef Name=\''+a.column+'\' LookupId=\'TRUE\'/> <Value Type=\''+a.type+'\'>'+a.value+'</Value>',o+='</'+a.operation+'>'}),o+='</'+a.where.operation+'>';else{if('Array'===a.where.value.constructor.name&&(e=!0),'in'===a.where.operation.toLowerCase()&&e&&60<a.where.value.length&&(d=!0,f=Math.ceil(a.where.value.length/60)),d){o+='<Or>';for(var q=0;q<f;q++)o+='<In> <FieldRef Name=\''+a.where.column+'\' /> <Values>',a.where.value.forEach(function(b){o+='<Value Type=\''+a.where.type+'\'>'+b+'</Value>'}),o+='</Values></In>'}else o+='<'+a.where.operation+'>',e?(o+='lookup'!==a.where.type.toLowerCase()||isNaN(a.where.value[0])?' <FieldRef Name=\''+a.where.column+'\' />':' <FieldRef Name=\''+a.where.column+'\' LookupId=\'TRUE\'/>',o+='<Values>',a.where.value.forEach(function(b){o+='<Value Type=\''+a.where.type+'\'>'+b+'</Value>'}),o+='</Values>'):(o+='undefined'==typeof a.where.type||'lookup'!==a.where.type.toLowerCase()||isNaN(a.where.value)?' <FieldRef Name=\''+a.where.column+'\' />':' <FieldRef Name=\''+a.where.column+'\' LookupId=\'TRUE\'/>','undefined'!=typeof a.where.type&&'undefined'!=typeof a.where.value&&(o+='<Value Type=\''+a.where.type+'\'>'+a.where.value+'</Value>')),o+='</'+a.where.operation+'>';d&&(o+='</Or>')}o+='</Where></Query>'}if('undefined'!=typeof a.join){for(var i in o+='\n                    <Joins>\n                        <Join Type="'+a.join.direction+'" ListAlias="'+a.join.list+'">\n                            <Eq>\n                                <FieldRef Name="'+a.join.joinColumn+'" RefType="Id" />\n                                <FieldRef Name="ID" List="'+a.join.list+'" />\n                            </Eq>\n                        </Join>\n                    </Joins>',o+='<ProjectedFields>',a.join.getColumns)o+='<Field ShowField="'+a.join.getColumns[i]+'" Type="Lookup" Name="'+a.join.getColumns[i]+'" List="'+a.join.list+'" />';o+='</ProjectedFields>'}o+='</View>',n.set_viewXml(o)}var g=new SP.ListItemCollectionPosition;g.set_pagingInfo('Paged=TRUE&p_ID='+a.pagePosition),n.set_listItemCollectionPosition(g);var r=m.getItems(n);this.appContext.load(r,'Include('+a.listColumns.toString()+')');var h=this,j=function(){for(var c=r.getEnumerator(),d=[];c.moveNext();){var e=c.get_current(),f={},g=!0,h=!1,i=void 0;try{for(var j,k,l=a.listColumns[Symbol.iterator]();!(g=(j=l.next()).done);g=!0){k=j.value;try{f[k]=e.get_item(k)}catch(b){if('undefined'!=typeof a.listName)throw'spHelper Error: The column \''+k+'\' requested from \''+a.listName+'\' does not exist! Error: '+b;else throw'spHelper Error: The column \''+k+'\' requested from \''+a.listGuid+'\' does not exist! Error: '+b}}}catch(a){h=!0,i=a}finally{try{!g&&l.return&&l.return()}finally{if(h)throw i}}d.push(f)}b(d)},k=function(a,b){c(b.get_message())};this.appContext.executeQueryAsync(j,k)}catch(a){throw'spHelper Error: Unable to read list data. Validate query details ... '+a}}},{key:'updateListItem',value:function f(a,b,c){if('undefined'==typeof a.listName||'undefined'==typeof a.itemID||'undefined'==typeof a.columnData)throw'spHelper Error: Invalid update details. To update an item, the list name, item ID, and column update data is required.';try{var d=this.spWeb.get_lists().getByTitle(a.listName),e=d.getItemById(a.itemID);for(var g in a.columnData)if('url'==a.columnData[g].Type.toLowerCase())try{var h=new SP.FieldUrlValue;h.set_url(a.columnData[g].URL),h.set_description(a.columnData[g].Description),e.set_item(g,h)}catch(a){throw'spHelper Error: Invalid URL field details. Unable to update item ... '+a}else if('lookup'==a.columnData[g].Type.toLowerCase())try{if(''!==a.columnData[g].LookupID){var i=new SP.FieldLookupValue;i.set_lookupId(a.columnData[g].LookupID),e.set_item(g,i)}else e.set_item(g,null)}catch(a){throw'spHelper Error: Invalid Lookup field details. Unable to update item ... '+a}else'user'===a.columnData[g].Type.toLowerCase()?function(){var b=[];if('String'===a.columnData[g].Value.constructor.name){var c=new SP.FieldUserValue.fromUser(a.columnData[g].Value);b.push(c)}else a.columnData[g].Value.forEach(function(a){var c=new SP.FieldUserValue.fromUser(a);b.push(c)});e.set_item(g,b)}():e.set_item(g,a.columnData[g].Value);e.update(),this.appContext.executeQueryAsync(b,c)}catch(a){throw'spHelper Error: Unable to update item. Validate update details ... '+a}}},{key:'addListItem',value:function g(a,b,c){if('undefined'==typeof a.listName||'undefined'==typeof a.columnData)throw'spHelper Error: Invalid create item details. To create an item, listName and columnData must be defined.';try{var d=this.spWeb.get_lists().getByTitle(a.listName),e=new SP.ListItemCreationInformation,f=d.addItem(e);for(var h in a.columnData)if('url'===a.columnData[h].Type.toLowerCase())try{var i=new SP.FieldUrlValue;i.set_url(a.columnData[h].URL),i.set_description(a.columnData[h].Description),f.set_item(h,i)}catch(a){throw'spHelper Error: Invalid URL field details. Unable to add item ... '+a}else if('lookup'===a.columnData[h].Type.toLowerCase())try{if('Number'===a.columnData[h].LookupID.constructor.name||'String'===a.columnData[h].LookupID.constructor.name){var j=new SP.FieldLookupValue;j.set_lookupId(a.columnData[h].LookupID),f.set_item(h,j)}else(function(){var b=[];a.columnData[h].LookupID.forEach(function(a){var c=new SP.FieldLookupValue;c.set_lookupId(a),b.push(c)}),f.set_item(h,b)})()}catch(a){throw'spHelper Error: Invalid Lookup field details. Unable to add item ... '+a}else'user'===a.columnData[h].Type.toLowerCase()?function(){var b=[];if('String'===a.columnData[h].Value.constructor.name){var c=new SP.FieldUserValue.fromUser(a.columnData[h].Value);b.push(c)}else a.columnData[h].Value.forEach(function(a){var c=new SP.FieldUserValue.fromUser(a);b.push(c)});f.set_item(h,b)}():f.set_item(h,a.columnData[h].Value);f.update(),this.appContext.executeQueryAsync(function a(){b(f.get_id())},c)}catch(a){throw'SPHelper Error: Unable to add new item. Validate create details ... '+a}}},{key:'addListItemAttachment',value:function g(a,b,c){var d=this.spWeb.get_lists().getByTitle(a.listName);this.appContext.load(d,'RootFolder');var e=d.getItemById(a.itemID);this.appContext.load(e);var f=this;this.appContext.executeQueryAsync(function h(){if(!e.get_fieldValues().Attachments){var b=d.get_rootFolder().get_serverRelativeUrl()+'/Attachments',c=f.spWeb.getFolderByServerRelativeUrl(b),g=c.get_folders().add('_'+a.itemID);g.moveTo(b+'/'+a.itemID),f.appContext.load(g),f.appContext.executeQueryAsync(function(a){console.log(a)},function(a,b){console.log(b.get_message())})}else;},function d(a,b){c(b.get_message())})}},{key:'deleteListItem',value:function f(a,b,c){if('undefined'==typeof a.listName||'undefined'==typeof a.itemID)throw'spHelper Error: Invalid delete details. To update an item, the list name and item ID is required.';try{var d=this.spWeb.get_lists().getByTitle(a.listName),e=d.getItemById(a.itemID);e.deleteObject(),this.appContext.executeQueryAsync(b,c)}catch(a){throw'spHelper Error: Unable to delete item. Validate update details ... '+a}}},{key:'getListContentTypeDefault',value:function i(a,b,c){try{var d=this.spWeb.get_lists().getByTitle(a),e=d.get_contentTypes();this.appContext.load(e);var f=this,g=function(){var a=e.getEnumerator();a.moveNext(),b(a.get_current().get_id().toString())},h=function(a,b){c(b.get_message())};this.appContext.executeQueryAsync(g,h)}catch(a){throw'spHelper Error: Unable to get list default content type ... '+a}}},{key:'getListDetails',value:function h(a,b,c){var d=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];try{var e=this,f=function(c){var f={},h=e.spWeb.get_lists().getByTitle(a),i=h.get_contentTypes(),j=i.getById(c),k=j.get_fields(),l=h.get_rootFolder();e.appContext.load(k),e.appContext.load(h),e.appContext.load(l),e.appContext.load(e.spWeb);e.appContext.executeQueryAsync(function o(){f.settings={},f.settings.id=h.get_id().toString(),f.settings.title=h.get_title(),f.settings.enableAttachments=h.get_enableAttachments(),f.settings.contentTypesEnabled=h.get_contentTypesEnabled(),f.settings.description=h.get_description(),f.settings.enableFolderCreation=h.get_enableFolderCreation(),f.settings.enableMinorVersions=h.get_enableMinorVersions(),f.settings.enableModeration=h.get_enableModeration(),f.settings.enableVersioning=h.get_enableVersioning(),f.settings.forceCheckout=h.get_forceCheckout(),f.settings.parentWebUrl=h.get_parentWebUrl(),f.settings.template=h.get_baseTemplate(),f.settings.rootFolder=l.get_serverRelativeUrl(),f.settings.internalName=l.get_name(),f.settings.serverRelativeURL=100==f.settings.template?e.spWeb.get_url()+'/Lists/'+f.settings.internalName+'/':e.spWeb.get_url()+'/'+f.settings.internalName+'/';var a=k.getEnumerator();for(f.columns=[];a.moveNext();){var c={},g=a.get_current();if('ContentType'!==g.get_internalName()){if(d&&!0===g.get_readOnlyField())continue;c={id:g.get_id().toString(),title:g.get_title(),internalName:g.get_internalName(),default:g.get_defaultValue(),unique:g.get_enforceUniqueValues(),required:g.get_required(),hidden:g.get_hidden(),description:g.get_description(),fieldType:g.get_fieldTypeKind()};var i=new DOMParser,j=g.get_schemaXml(),m=i.parseFromString(j,'text/xml'),n=m.getElementsByTagName('Field')[0].attributes;2===g.get_fieldTypeKind()&&(c.maxLength=g.get_maxLength()),(6===g.get_fieldTypeKind()||15===g.get_fieldTypeKind())&&(c.choices=g.get_choices(),c.fillInChoice=g.get_fillInChoice(),6===g.get_fieldTypeKind()&&(c.editFormat=g.get_editFormat())),3===g.get_fieldTypeKind()&&(c.numberOfLines=g.get_numberOfLines(),c.richText=g.get_richText(),c.appendOnly=g.get_appendOnly()),(9===g.get_fieldTypeKind()||10===g.get_fieldTypeKind())&&(c.minimumValue=g.get_minimumValue(),c.maximumValue=g.get_maximumValue(),9===g.get_fieldTypeKind()&&(c.showAsPercentage='undefined'!=typeof n.Percentage&&'FALSE'!==n.Percentage.value,'undefined'!=typeof n.Decimals&&(c.displayFormat=parseInt(n.Decimals.value))),10===g.get_fieldTypeKind()&&(c.currencyLocaleId=g.get_currencyLocaleId())),4===g.get_fieldTypeKind()&&(c.displayFormat=g.get_displayFormat(),c.friendlyDisplayFormat=g.get_friendlyDisplayFormat()),7===g.get_fieldTypeKind()&&(c.allowMultipleValues=g.get_allowMultipleValues(),c.lookupList=g.get_lookupList(),c.lookupField=g.get_lookupField()),20===g.get_fieldTypeKind()&&(c.allowMultipleValues=g.get_allowMultipleValues()),11===g.get_fieldTypeKind()&&(c.displayFormat=g.get_displayFormat()),17===g.get_fieldTypeKind()&&(c.resultType=n.ResultType.value,'Number'===n.ResultType.value&&(c.displayFormat=n.Decimals.value,c.showAsPercentage=n.Percentage.value),'Currency'===n.ResultType.value&&(c.displayFormat=n.Decimals.value,c.currencyLocaleId=n.LCID.value)),f.columns.push(c)}}b(f)},function c(a,b){g(b.get_message())})},g=function(a){c(a)};this.getListContentTypeDefault(a,f,g)}catch(a){throw'spHelper Error: Unable to get list details ... '+a}}},{key:'getUserProperty',value:function f(a,b,c){if('undefined'==typeof a)throw'spHelper Error: Unable to get the user property. Ensure the userProperty [ARRAY] is correctly configured.';try{var g=this.spWeb.get_currentUser();this.appContext.load(g,a);var d=function(){var c={};a.includes('Title')&&(c.Title=g.get_title()),a.includes('id')&&(c.ID=g.get_id()),a.includes('email')&&(c.Email=g.get_email()),b(c)},e=function(a,b){c(b.get_message())};this.appContext.executeQueryAsync(d,e)}catch(a){throw'spHelper Error: Unable to get the user property. Validate the request details.'+a}}},{key:'searchUsers',value:function g(a,b,c){var d=new SP.UI.ApplicationPages.ClientPeoplePickerQueryParameters;d.set_allowMultipleEntities(!1),d.set_maximumEntitySuggestions(50),d.set_principalType(1),d.set_principalSource(15),d.set_queryString(a);var e=SP.UI.ApplicationPages.ClientPeoplePickerWebServiceInterface.clientPeoplePickerSearchUser(this.appContext,d),f=this;this.appContext.executeQueryAsync(function h(){var a=JSON.parse(e.get_value());if(a){var d=[],g=[];a.forEach(function(a){g.push(new Promise(function(b){f.getUserProfile(a.Description,function c(a){null!==a&&d.push(a),b()},function b(a){c(a)})}))}),Promise.all(g).then(function(){b(d)})}else b(null)},function d(a,b){c(b.get_message())})}},{key:'getUserProfile',value:function f(a,b,c){var d=new SP.UserProfiles.PeopleManager(this.appContext),e=d.getPropertiesFor(a);this.appContext.load(e),this.appContext.executeQueryAsync(function(){try{b(e.get_userProfileProperties())}catch(a){b(null)}},function(a,b){c(b.get_message())})}},{key:'getCurrentUser',value:function e(a,b){var c=new SP.UserProfiles.PeopleManager(this.appContext),d=c.getMyProperties();this.appContext.load(d),this.appContext.executeQueryAsync(function(){try{a(d.get_userProfileProperties())}catch(b){a(null)}},function(a,c){b(c.get_message())})}},{key:'getCurrentUserManager',value:function d(a,b){var c=this;this.getCurrentUser(function e(d){c.getUserProfile(d.Manager,a,b)},function b(a){console.log(a)})}},{key:'fieldType',value:function b(a){return'String'===a.constructor.name?SP.FieldType[a]:1===a?'integer':2===a?'text':3===a?'note':4===a?'dateTime':5===a?'counter':6===a?'choice':7===a?'lookup':8===a?'boolean':9===a?'number':10===a?'currency':11===a?'URL':12===a?'computed':13===a?'threading':14===a?'guid':15===a?'multiChoice':16===a?'gridChoice':17===a?'calculated':18===a?'file':19===a?'attachments':20===a?'user':21===a?'recurrence':22===a?'crossProjectLink':23===a?'modStat':24===a?'error':25===a?'contentTypeId':26===a?'pageSeparator':27===a?'threadIndex':28===a?'workflowStatus':29===a?'allDayEvent':30===a?'workflowEventType':31===a?'maxItems':void 0}},{key:'dateType',value:function b(a){return SP.DateTimeFieldFormatType[a]}},{key:'numberFormatType',value:function b(a){return'automatic'===a.toLowerCase()?'undefined':'nodecimal'===a.toLowerCase()?0:'onedecimal'===a.toLowerCase()?1:'twodecimals'===a.toLowerCase()?2:'threedecimals'===a.toLowerCase()?3:'fourdecimals'===a.toLowerCase()?4:'fivedecimals'===a.toLowerCase()?5:void 0}}]),a}();exports.default=spHelper;